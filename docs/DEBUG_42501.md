# üîç Debug Erreur 42501 Persistante

## Probl√®me

L'erreur persiste m√™me apr√®s red√©ploiement. Les logs montrent :
- ‚úÖ `supabaseUrl: 'defined'`
- ‚úÖ `supabaseKey: 'defined'` (cl√© anon)
- ‚ùå **PAS de `serviceRoleKey` dans les logs**
- ‚ùå **PAS de `hasSupabaseAdmin` dans les logs**

Cela signifie que soit :
1. Les logs de diagnostic ne s'affichent pas
2. `SUPABASE_SERVICE_ROLE_KEY` n'est toujours pas charg√©e
3. Le code n'arrive pas jusqu'aux logs de diagnostic

## üîç V√©rifications √† faire

### 1. Chercher "Supabase Admin not configured" dans les logs

Si `SUPABASE_SERVICE_ROLE_KEY` n'est pas charg√©e, vous devriez voir :

```
Supabase Admin not configured: {
  hasUrl: true,
  hasServiceKey: false
}
```

**Si vous voyez ce message** : `SUPABASE_SERVICE_ROLE_KEY` n'est pas charg√©e.

### 2. Chercher "Vote insertion attempt" dans les logs

Si le code arrive jusqu'√† l'insertion, vous devriez voir :

```
Vote insertion attempt: {
  hasSupabaseAdmin: true/false,
  serviceRoleKey: "defined"/"undefined"
}
```

**Si vous ne voyez PAS ce message** : Le code s'arr√™te avant (probablement √† la v√©rification du client admin).

### 3. V√©rifier la variable dans Vercel

1. Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables
2. Chercher `SUPABASE_SERVICE_ROLE_KEY`
3. V√©rifier :
   - ‚úÖ La variable existe
   - ‚úÖ La valeur est correcte
   - ‚úÖ L'environnement est "Production" ou "All Environments"
   - ‚ö†Ô∏è **V√©rifier qu'il n'y a PAS d'espaces avant/apr√®s la valeur**

### 4. V√©rifier le d√©ploiement

1. Vercel Dashboard ‚Üí Deployments
2. V√©rifier que le dernier d√©ploiement a √©t√© cr√©√© **apr√®s** la modification de la variable
3. V√©rifier que le d√©ploiement est termin√© (status "Ready")

## üîß Solutions possibles

### Solution 1 : V√©rifier que la variable est dans le bon environnement

Dans Vercel, v√©rifier que `SUPABASE_SERVICE_ROLE_KEY` est configur√©e pour **"Production"** :
- Si elle est seulement dans "Preview" ou "Development", elle ne sera pas charg√©e en production

### Solution 2 : Supprimer et recr√©er la variable

Parfois, il y a des probl√®mes de cache. Essayer :
1. Supprimer `SUPABASE_SERVICE_ROLE_KEY` dans Vercel
2. La recr√©er avec la m√™me valeur
3. Red√©ployer

### Solution 3 : V√©rifier la cl√©

1. Aller sur Supabase Dashboard ‚Üí Settings ‚Üí API
2. Copier la cl√© **"service_role"** (pas "anon public")
3. V√©rifier qu'elle commence par `eyJhbGci...`
4. V√©rifier qu'elle est diff√©rente de `NEXT_PUBLIC_SUPABASE_ANON_KEY`

### Solution 4 : V√©rifier les logs complets

Dans Vercel Dashboard ‚Üí Logs, chercher TOUS les logs lors d'un vote :
- Chercher "Supabase Admin not configured"
- Chercher "Vote insertion attempt"
- Chercher "Supabase vote error"

Cela nous dira exactement o√π le code s'arr√™te.

## üìã Checklist de debug

- [ ] Chercher "Supabase Admin not configured" dans les logs
- [ ] Chercher "Vote insertion attempt" dans les logs
- [ ] V√©rifier que `SUPABASE_SERVICE_ROLE_KEY` existe dans Vercel
- [ ] V√©rifier que la variable est dans "Production"
- [ ] V√©rifier qu'il n'y a pas d'espaces dans la valeur
- [ ] V√©rifier que le d√©ploiement est r√©cent
- [ ] V√©rifier que la cl√© est correcte (service_role, pas anon)

## üÜò Si rien ne fonctionne

1. **Partager tous les logs** lors d'un vote (pas seulement l'erreur)
2. **V√©rifier la cl√©** : Est-ce bien la cl√© "service_role" ?
3. **Tester avec un nouveau d√©ploiement** : Faire un petit changement de code et pousser pour forcer un nouveau d√©ploiement
